import os
import zipfile
import magic
bindir='/home/mark/theZoo/malwares/Binaries'
destination='/home/mark/File-Entropy-master/malware'

print(bindir)
print(destination)

for folder in os.listdir(bindir):
    name=folder
    print(name)
    for sample in os.listdir(os.path.join(bindir,folder)):
        if sample.endswith('.zip'):
            print(sample)
            try:
                with zipfile.ZipFile(os.path.join(bindir,folder,sample),'r') as zippedsample:
                    zippedsample.setpassword(bytes('infected'.encode('utf8')))
                    listoffiles=zippedsample.namelist()

                    for filename in listoffiles:
                        magictype = magic.from_buffer(zippedsample.read(filename))
                        if filename.lower().endswith('.exe') or 'MS' in magictype:
                            print(filename, magictype)
                            zippedsample.extract(filename, path=destination)
                            finalpath = os.path.join(destination, name+'.exe')
                            counter=1
                            while os.path.exists(finalpath):
                                finalpath = os.path.join(destination, name+str(counter)+'.exe')
                                counter += 1
                            os.rename(os.path.join(destination, filename), finalpath)
            except (zipfile.BadZipFile, RuntimeError):
                continue
